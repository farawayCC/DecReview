// const contractAddress = 'TFM68QBt4bD9YqYCxp4BhyaUYn4uzQXrBJ'

const utils = {
    tronWeb: false,
    contract: false,
    factoryContractAddress: 'TFM68QBt4bD9YqYCxp4BhyaUYn4uzQXrBJ',

    setTronWeb(tronWeb) {
        this.tronWeb = tronWeb;
        this.contract = tronWeb.contract(this.factoryAbi, this.factoryContractAddress)
    },

    async fetchProducts() {
        // console.log("In Utils.fetchProducts()");
        const deployedProducts = await this.contract.getDeployedProducts().call();
        const products = [];
        //show last 5 products
        for (var i = 0; i < 4; i++) {
            const address = deployedProducts[deployedProducts.length-1-i];
            const product = this.fetchProduct(address);
            products.push(product);
        }

        // console.log("Fetched products: " + products);
        return {
          products
        };
    },

    async fetchProduct(address) {
      const productContract = tronWeb.contract(this.productAbi, address);
      const name = await productContract.name().call();
      const photoLink = await productContract.photoLink().call();
      const category = await productContract.category().call();
      const avgRating = getAvgRate(address);

      console.log("Fetched product.name: " +name);
      return {
        name,
        photoLink,
        category,
        avgRating,
        address
      };
    },

    async getAvgRate(address) {
      const productContract = tronWeb.contract(this.productAbi, address);
      const avgRate = 0;
      const reviewsCount = await productContract.getReviewsCount().call();
      console.log("Starting to get reviews");
      const reviews = await Promise.all(
        Array(parseInt(reviewsCount))
          .fill()
          .map((element, index) => {
            return productContract.reviews(index).call();
          })
      ).catch(err => {
        console.log("Error while trying to get all reviews for address: " + address + ". \n Error message: " + err.message)
      });
      console.log("Fetched reviews: " + reviews);
      let sum = 0;
      for (var j = 0; j < reviewsCount; j++) {
        sum=parseInt(sum)+parseInt(reviews[j].rate);
      }
      const avgRating = (sum/reviewsCount);

      return {
        avgRating
      };
    },

    productAbi: [{"constant":true,"inputs":[],"name":"creator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getReviewsCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newHeader","type":"string"},{"name":"newText","type":"string"},{"name":"newRate","type":"uint256"},{"name":"newPhotoLink","type":"string"}],"name":"createReview","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"markAsDeleted","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"index","type":"uint256"}],"name":"upvoteReview","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getSummary","outputs":[{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"string"},{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"photoLink","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isDeleted","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"reviews","outputs":[{"name":"header","type":"string"},{"name":"text","type":"string"},{"name":"rate","type":"uint256"},{"name":"photoLink","type":"string"},{"name":"author","type":"address"},{"name":"isDeleted","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"category","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"productName","type":"string"},{"name":"productCategory","type":"string"},{"name":"productPhotoLink","type":"string"},{"name":"productCreator","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}],

    factoryAbi: [{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"deployedProducts","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getDeployedProducts","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"productName","type":"string"},{"name":"productCategory","type":"string"},{"name":"productPhotoLink","type":"string"}],"name":"createProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}],

    productBytecode: '60806040523480156200001157600080fd5b506040516200102238038062001022833981016040908152815160208084015192840151606085015192850180519095948501949190910192916200005c91600191870190620000b9565b50815162000072906002906020850190620000b9565b50825162000088906003906020860190620000b9565b5060048054600160a060020a039092166101000261010060a860020a0319909216919091179055506200015e915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620000fc57805160ff19168380011785556200012c565b828001600101855582156200012c579182015b828111156200012c5782518255916020019190600101906200010f565b506200013a9291506200013e565b5090565b6200015b91905b808211156200013a576000815560010162000145565b90565b610eb4806200016e6000396000f3006080604052600436106100ae5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166302d05d3f81146100b357806306fdde03146100e45780631435ba3c1461016e578063147b68db146101955780633009060d146102725780633ced6738146102875780634051ddac1461029f578063d06f73ac14610407578063d7efb6b71461041c578063e83ddcea14610445578063ef430aa6146105c1575b600080fd5b3480156100bf57600080fd5b506100c86105d6565b60408051600160a060020a039092168252519081900360200190f35b3480156100f057600080fd5b506100f96105ea565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561013357818101518382015260200161011b565b50505050905090810190601f1680156101605780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561017a57600080fd5b50610183610677565b60408051918252519081900360200190f35b3480156101a157600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261027094369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b8a359b909a90999401975091955091820193509150819084018382808284375094975061067e9650505050505050565b005b34801561027e57600080fd5b506102706107cf565b34801561029357600080fd5b506102706004356107fa565b3480156102ab57600080fd5b506102b461084f565b60408051600160a060020a0383166060820152608080825286519082015285519091829160208084019284019160a08501918a019080838360005b838110156103075781810151838201526020016102ef565b50505050905090810190601f1680156103345780820380516001836020036101000a031916815260200191505b50848103835287518152875160209182019189019080838360005b8381101561036757818101518382015260200161034f565b50505050905090810190601f1680156103945780820380516001836020036101000a031916815260200191505b50848103825286518152865160209182019188019080838360005b838110156103c75781810151838201526020016103af565b50505050905090810190601f1680156103f45780820380516001836020036101000a031916815260200191505b5097505050505050505060405180910390f35b34801561041357600080fd5b506100f9610a38565b34801561042857600080fd5b50610431610a90565b604080519115158252519081900360200190f35b34801561045157600080fd5b5061045d600435610a99565b60408051908101859052600160a060020a038316608082015281151560a082015260c080825287519082015286518190602080830191606084019160e0850191908c019080838360005b838110156104bf5781810151838201526020016104a7565b50505050905090810190601f1680156104ec5780820380516001836020036101000a031916815260200191505b5084810383528951815289516020918201918b019080838360005b8381101561051f578181015183820152602001610507565b50505050905090810190601f16801561054c5780820380516001836020036101000a031916815260200191505b50848103825287518152875160209182019189019080838360005b8381101561057f578181015183820152602001610567565b50505050905090810190601f1680156105ac5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b3480156105cd57600080fd5b506100f9610cad565b6004546101009004600160a060020a031681565b60018054604080516020600284861615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561066f5780601f106106445761010080835404028352916020019161066f565b820191906000526020600020905b81548152906001019060200180831161065257829003601f168201915b505050505081565b6000545b90565b610686610d08565b848152602080820185905260408201849052606082018390523360a0830152600060c08301819052805460018101808355918052835180519293859360069093027f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56301926106f79284920190610d51565b5060208281015180516107109260018501920190610d51565b506040820151600282015560608201518051610736916003840191602090910190610d51565b5060808201518051610752916004840191602090910190610dcf565b5060a08201516005909101805460c0909301511515740100000000000000000000000000000000000000000274ff000000000000000000000000000000000000000019600160a060020a0390931673ffffffffffffffffffffffffffffffffffffffff199094169390931791909116919091179055505050505050565b6004546101009004600160a060020a031633146107eb57600080fd5b6004805460ff19166001179055565b6000808281548110151561080a57fe5b600091825260208083206004600690930201919091018054600181018255908352912001805473ffffffffffffffffffffffffffffffffffffffff1916331790555050565b60608060606000600160026003600460019054906101000a9004600160a060020a0316838054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109075780601f106108dc57610100808354040283529160200191610907565b820191906000526020600020905b8154815290600101906020018083116108ea57829003601f168201915b5050865460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152959950889450925084019050828280156109955780601f1061096a57610100808354040283529160200191610995565b820191906000526020600020905b81548152906001019060200180831161097857829003601f168201915b5050855460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815295985087945092508401905082828015610a235780601f106109f857610100808354040283529160200191610a23565b820191906000526020600020905b815481529060010190602001808311610a0657829003601f168201915b50505050509150935093509350935090919293565b6002805460408051602060018416156101000260001901909316849004601f8101849004840282018401909252818152929183018282801561066f5780601f106106445761010080835404028352916020019161066f565b60045460ff1681565b6000805482908110610aa757fe5b60009182526020918290206006919091020180546040805160026001841615610100026000190190931692909204601f810185900485028301850190915280825291935091839190830182828015610b405780601f10610b1557610100808354040283529160200191610b40565b820191906000526020600020905b815481529060010190602001808311610b2357829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bde5780601f10610bb357610100808354040283529160200191610bde565b820191906000526020600020905b815481529060010190602001808311610bc157829003601f168201915b505050506002838101546003850180546040805160206001841615610100026000190190931695909504601f810183900483028601830190915280855295969295929450909190830182828015610c765780601f10610c4b57610100808354040283529160200191610c76565b820191906000526020600020905b815481529060010190602001808311610c5957829003601f168201915b50505060059093015491925050600160a060020a0381169060ff740100000000000000000000000000000000000000009091041686565b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561066f5780601f106106445761010080835404028352916020019161066f565b60e06040519081016040528060608152602001606081526020016000815260200160608152602001606081526020016000600160a060020a031681526020016000151581525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610d9257805160ff1916838001178555610dbf565b82800160010185558215610dbf579182015b82811115610dbf578251825591602001919060010190610da4565b50610dcb929150610e3d565b5090565b828054828255906000526020600020908101928215610e31579160200282015b82811115610e31578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03909116178255602090920191600190910190610def565b50610dcb929150610e57565b61067b91905b80821115610dcb5760008155600101610e43565b61067b91905b80821115610dcb57805473ffffffffffffffffffffffffffffffffffffffff19168155600101610e5d5600a165627a7a723058206fd1be9b3285f3c6fdd0be05bb2a5bda9f84d9fe624e394ab47b7ba83b312aaa0029',

    factoryBytecode: '608060405234801561001057600080fd5b506114c6806100206000396000f3006080604052600436106100565763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663435c2e38811461005b578063a578861d1461009c578063d768468b14610101575b600080fd5b34801561006757600080fd5b506100736004356101d8565b6040805173ffffffffffffffffffffffffffffffffffffffff9092168252519081900360200190f35b3480156100a857600080fd5b506100b161020d565b60408051602080825283518183015283519192839290830191858101910280838360005b838110156100ed5781810151838201526020016100d5565b505050509050019250505060405180910390f35b34801561010d57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526101d694369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375094975061027c9650505050505050565b005b60008054829081106101e657fe5b60009182526020909120015473ffffffffffffffffffffffffffffffffffffffff16905081565b6060600080548060200260200160405190810160405280929190818152602001828054801561027257602002820191906000526020600020905b815473ffffffffffffffffffffffffffffffffffffffff168152600190910190602001808311610247575b5050505050905090565b60008383833361028a610468565b73ffffffffffffffffffffffffffffffffffffffff82166060820152608080825285519082015284518190602080830191604084019160a0850191908a019080838360005b838110156102e75781810151838201526020016102cf565b50505050905090810190601f1680156103145780820380516001836020036101000a031916815260200191505b50848103835287518152875160209182019189019080838360005b8381101561034757818101518382015260200161032f565b50505050905090810190601f1680156103745780820380516001836020036101000a031916815260200191505b50848103825286518152865160209182019188019080838360005b838110156103a757818101518382015260200161038f565b50505050905090810190601f1680156103d45780820380516001836020036101000a031916815260200191505b50975050505050505050604051809103906000f0801580156103fa573d6000803e3d6000fd5b50600080546001810182559080527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56301805473ffffffffffffffffffffffffffffffffffffffff191673ffffffffffffffffffffffffffffffffffffffff9290921691909117905550505050565b6040516110228061047983390190560060806040523480156200001157600080fd5b506040516200102238038062001022833981016040908152815160208084015192840151606085015192850180519095948501949190910192916200005c91600191870190620000b9565b50815162000072906002906020850190620000b9565b50825162000088906003906020860190620000b9565b5060048054600160a060020a039092166101000261010060a860020a0319909216919091179055506200015e915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620000fc57805160ff19168380011785556200012c565b828001600101855582156200012c579182015b828111156200012c5782518255916020019190600101906200010f565b506200013a9291506200013e565b5090565b6200015b91905b808211156200013a576000815560010162000145565b90565b610eb4806200016e6000396000f3006080604052600436106100ae5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166302d05d3f81146100b357806306fdde03146100e45780631435ba3c1461016e578063147b68db146101955780633009060d146102725780633ced6738146102875780634051ddac1461029f578063d06f73ac14610407578063d7efb6b71461041c578063e83ddcea14610445578063ef430aa6146105c1575b600080fd5b3480156100bf57600080fd5b506100c86105d6565b60408051600160a060020a039092168252519081900360200190f35b3480156100f057600080fd5b506100f96105ea565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561013357818101518382015260200161011b565b50505050905090810190601f1680156101605780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561017a57600080fd5b50610183610677565b60408051918252519081900360200190f35b3480156101a157600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261027094369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b8a359b909a90999401975091955091820193509150819084018382808284375094975061067e9650505050505050565b005b34801561027e57600080fd5b506102706107cf565b34801561029357600080fd5b506102706004356107fa565b3480156102ab57600080fd5b506102b461084f565b60408051600160a060020a0383166060820152608080825286519082015285519091829160208084019284019160a08501918a019080838360005b838110156103075781810151838201526020016102ef565b50505050905090810190601f1680156103345780820380516001836020036101000a031916815260200191505b50848103835287518152875160209182019189019080838360005b8381101561036757818101518382015260200161034f565b50505050905090810190601f1680156103945780820380516001836020036101000a031916815260200191505b50848103825286518152865160209182019188019080838360005b838110156103c75781810151838201526020016103af565b50505050905090810190601f1680156103f45780820380516001836020036101000a031916815260200191505b5097505050505050505060405180910390f35b34801561041357600080fd5b506100f9610a38565b34801561042857600080fd5b50610431610a90565b604080519115158252519081900360200190f35b34801561045157600080fd5b5061045d600435610a99565b60408051908101859052600160a060020a038316608082015281151560a082015260c080825287519082015286518190602080830191606084019160e0850191908c019080838360005b838110156104bf5781810151838201526020016104a7565b50505050905090810190601f1680156104ec5780820380516001836020036101000a031916815260200191505b5084810383528951815289516020918201918b019080838360005b8381101561051f578181015183820152602001610507565b50505050905090810190601f16801561054c5780820380516001836020036101000a031916815260200191505b50848103825287518152875160209182019189019080838360005b8381101561057f578181015183820152602001610567565b50505050905090810190601f1680156105ac5780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b3480156105cd57600080fd5b506100f9610cad565b6004546101009004600160a060020a031681565b60018054604080516020600284861615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561066f5780601f106106445761010080835404028352916020019161066f565b820191906000526020600020905b81548152906001019060200180831161065257829003601f168201915b505050505081565b6000545b90565b610686610d08565b848152602080820185905260408201849052606082018390523360a0830152600060c08301819052805460018101808355918052835180519293859360069093027f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56301926106f79284920190610d51565b5060208281015180516107109260018501920190610d51565b506040820151600282015560608201518051610736916003840191602090910190610d51565b5060808201518051610752916004840191602090910190610dcf565b5060a08201516005909101805460c0909301511515740100000000000000000000000000000000000000000274ff000000000000000000000000000000000000000019600160a060020a0390931673ffffffffffffffffffffffffffffffffffffffff199094169390931791909116919091179055505050505050565b6004546101009004600160a060020a031633146107eb57600080fd5b6004805460ff19166001179055565b6000808281548110151561080a57fe5b600091825260208083206004600690930201919091018054600181018255908352912001805473ffffffffffffffffffffffffffffffffffffffff1916331790555050565b60608060606000600160026003600460019054906101000a9004600160a060020a0316838054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109075780601f106108dc57610100808354040283529160200191610907565b820191906000526020600020905b8154815290600101906020018083116108ea57829003601f168201915b5050865460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152959950889450925084019050828280156109955780601f1061096a57610100808354040283529160200191610995565b820191906000526020600020905b81548152906001019060200180831161097857829003601f168201915b5050855460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815295985087945092508401905082828015610a235780601f106109f857610100808354040283529160200191610a23565b820191906000526020600020905b815481529060010190602001808311610a0657829003601f168201915b50505050509150935093509350935090919293565b6002805460408051602060018416156101000260001901909316849004601f8101849004840282018401909252818152929183018282801561066f5780601f106106445761010080835404028352916020019161066f565b60045460ff1681565b6000805482908110610aa757fe5b60009182526020918290206006919091020180546040805160026001841615610100026000190190931692909204601f810185900485028301850190915280825291935091839190830182828015610b405780601f10610b1557610100808354040283529160200191610b40565b820191906000526020600020905b815481529060010190602001808311610b2357829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bde5780601f10610bb357610100808354040283529160200191610bde565b820191906000526020600020905b815481529060010190602001808311610bc157829003601f168201915b505050506002838101546003850180546040805160206001841615610100026000190190931695909504601f810183900483028601830190915280855295969295929450909190830182828015610c765780601f10610c4b57610100808354040283529160200191610c76565b820191906000526020600020905b815481529060010190602001808311610c5957829003601f168201915b50505060059093015491925050600160a060020a0381169060ff740100000000000000000000000000000000000000009091041686565b6003805460408051602060026001851615610100026000190190941693909304601f8101849004840282018401909252818152929183018282801561066f5780601f106106445761010080835404028352916020019161066f565b60e06040519081016040528060608152602001606081526020016000815260200160608152602001606081526020016000600160a060020a031681526020016000151581525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610d9257805160ff1916838001178555610dbf565b82800160010185558215610dbf579182015b82811115610dbf578251825591602001919060010190610da4565b50610dcb929150610e3d565b5090565b828054828255906000526020600020908101928215610e31579160200282015b82811115610e31578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03909116178255602090920191600190910190610def565b50610dcb929150610e57565b61067b91905b80821115610dcb5760008155600101610e43565b61067b91905b80821115610dcb57805473ffffffffffffffffffffffffffffffffffffffff19168155600101610e5d5600a165627a7a723058206fd1be9b3285f3c6fdd0be05bb2a5bda9f84d9fe624e394ab47b7ba83b312aaa0029a165627a7a72305820852e18f4f60bbaaada00bfa33c1cc230a0ff449742bd1eaa12e8329d712d16790029'
};

export default utils;
