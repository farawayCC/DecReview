const utils = {
    tronWeb: false,
    contract: false,
    factoryContractAddress: 'TFM68QBt4bD9YqYCxp4BhyaUYn4uzQXrBJ',

    setTronWeb(tronWeb) {
        this.tronWeb = tronWeb;
        this.contract = tronWeb.contract(this.factoryAbi, this.factoryContractAddress)
    },

    async fetchProducts() {
        const deployedProducts = await this.contract.getDeployedProducts().call();
        console.log(deployedProducts);
        const convertedAddresses = [];
        for (var i = 0; i < deployedProducts.length; i++) {
          convertedAddresses.push(
            deployedProducts[i].replace(/^(0x)/, '41')
          );
        }

        const products = [];
        for (var i = 0; i < deployedProducts.length; i++) {
            const address = convertedAddresses[convertedAddresses.length-1-i];
            const product = this.fetchProduct(address);
            products.push(product);
        }

        return {
          products
        };
    },

    async fetchProduct(address) {
      // console.log(address)
      const productContract = tronWeb.contract(this.productAbi, "TFM68QBt4bD9YqYCxp4BhyaUYn4uzQXrBJ");
      const name = await productContract.name().call().catch(err => {
        console.log(err);
      });
      console.log(productContract);
      console.log("name");
      console.log(name);
      const photoLink = await productContract.photoLink().call();
      const category = await productContract.category().call();
      const avgRating = getAvgRate(address);

      console.log("Fetched product.name: " + name);
      return {
        name,
        photoLink,
        category,
        avgRating,
        address // TODO: Add reviewsCount
      };
    },

    async getAvgRate(address) {
      console.log("Hi");
      const productContract = tronWeb.contract(this.productAbi, address);
      console.log("Bye");
      const avgRate = 0;
      const reviewsCount = await productContract.getReviewsCount().call();
      console.log("Starting to get reviews");
      const reviews = await Promise.all(
        Array(parseInt(reviewsCount))
          .fill()
          .map((element, index) => {
            return productContract.reviews(index).call();
          })
      ).catch(err => {
        console.log("Error while trying to get all reviews for address: " + address + ". \n Error message: " + err.message)
      });
      console.log("Fetched reviews: " + reviews);
      let sum = 0;
      for (var j = 0; j < reviewsCount; j++) {
        sum=parseInt(sum)+parseInt(reviews[j].rate);
      }
      const avgRating = (sum/reviewsCount);

      return {
        avgRating
      };
    },

    productAbi: [{"constant":true,"inputs":[],"name":"creator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"getReviewsCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newHeader","type":"string"},{"name":"newText","type":"string"},{"name":"newRate","type":"uint256"},{"name":"newPhotoLink","type":"string"}],"name":"createReview","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"markAsDeleted","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"index","type":"uint256"}],"name":"upvoteReview","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"photoLink","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isDeleted","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"reviews","outputs":[{"name":"header","type":"string"},{"name":"text","type":"string"},{"name":"rate","type":"uint256"},{"name":"photoLink","type":"string"},{"name":"author","type":"address"},{"name":"isDeleted","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"category","outputs":[{"name":"","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"productName","type":"string"},{"name":"productCategory","type":"string"},{"name":"productPhotoLink","type":"string"},{"name":"productCreator","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}],

    factoryAbi: [{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"deployedProducts","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"prod","type":"address"}],"name":"registerNewProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"getDeployedProducts","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"productName","type":"string"},{"name":"productCategory","type":"string"},{"name":"productPhotoLink","type":"string"}],"name":"createProduct","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"}],

    productBytecode: '608060405234801561001057600080fd5b50604051610cb1380380610cb183398101604090815281516020808401519284015160608501519285018051909594850194919091019291610057916001918701906100af565b50815161006b9060029060208501906100af565b50825161007f9060039060208601906100af565b5060048054600160a060020a039092166101000261010060a860020a03199092169190911790555061014a915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100f057805160ff191683800117855561011d565b8280016001018555821561011d579182015b8281111561011d578251825591602001919060010190610102565b5061012992915061012d565b5090565b61014791905b808211156101295760008155600101610133565b90565b610b58806101596000396000f3006080604052600436106100a35763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166302d05d3f81146100a857806306fdde03146100d95780631435ba3c14610163578063147b68db1461018a5780633009060d146102675780633ced67381461027c578063d06f73ac14610294578063d7efb6b7146102a9578063e83ddcea146102d2578063ef430aa61461044e575b600080fd5b3480156100b457600080fd5b506100bd610463565b60408051600160a060020a039092168252519081900360200190f35b3480156100e557600080fd5b506100ee610477565b6040805160208082528351818301528351919283929083019185019080838360005b83811015610128578181015183820152602001610110565b50505050905090810190601f1680156101555780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561016f57600080fd5b50610178610504565b60408051918252519081900360200190f35b34801561019657600080fd5b506040805160206004803580820135601f810184900484028501840190955284845261026594369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b8a359b909a90999401975091955091820193509150819084018382808284375094975061050b9650505050505050565b005b34801561027357600080fd5b5061026561065c565b34801561028857600080fd5b50610265600435610687565b3480156102a057600080fd5b506100ee6106dc565b3480156102b557600080fd5b506102be610734565b604080519115158252519081900360200190f35b3480156102de57600080fd5b506102ea60043561073d565b60408051908101859052600160a060020a038316608082015281151560a082015260c080825287519082015286518190602080830191606084019160e0850191908c019080838360005b8381101561034c578181015183820152602001610334565b50505050905090810190601f1680156103795780820380516001836020036101000a031916815260200191505b5084810383528951815289516020918201918b019080838360005b838110156103ac578181015183820152602001610394565b50505050905090810190601f1680156103d95780820380516001836020036101000a031916815260200191505b50848103825287518152875160209182019189019080838360005b8381101561040c5781810151838201526020016103f4565b50505050905090810190601f1680156104395780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b34801561045a57600080fd5b506100ee610951565b6004546101009004600160a060020a031681565b60018054604080516020600284861615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156104fc5780601f106104d1576101008083540402835291602001916104fc565b820191906000526020600020905b8154815290600101906020018083116104df57829003601f168201915b505050505081565b6000545b90565b6105136109ac565b848152602080820185905260408201849052606082018390523360a0830152600060c08301819052805460018101808355918052835180519293859360069093027f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563019261058492849201906109f5565b50602082810151805161059d92600185019201906109f5565b5060408201516002820155606082015180516105c39160038401916020909101906109f5565b50608082015180516105df916004840191602090910190610a73565b5060a08201516005909101805460c0909301511515740100000000000000000000000000000000000000000274ff000000000000000000000000000000000000000019600160a060020a0390931673ffffffffffffffffffffffffffffffffffffffff199094169390931791909116919091179055505050505050565b6004546101009004600160a060020a0316331461067857600080fd5b6004805460ff19166001179055565b6000808281548110151561069757fe5b600091825260208083206004600690930201919091018054600181018255908352912001805473ffffffffffffffffffffffffffffffffffffffff1916331790555050565b6002805460408051602060018416156101000260001901909316849004601f810184900484028201840190925281815292918301828280156104fc5780601f106104d1576101008083540402835291602001916104fc565b60045460ff1681565b600080548290811061074b57fe5b60009182526020918290206006919091020180546040805160026001841615610100026000190190931692909204601f8101859004850283018501909152808252919350918391908301828280156107e45780601f106107b9576101008083540402835291602001916107e4565b820191906000526020600020905b8154815290600101906020018083116107c757829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108825780601f1061085757610100808354040283529160200191610882565b820191906000526020600020905b81548152906001019060200180831161086557829003601f168201915b505050506002838101546003850180546040805160206001841615610100026000190190931695909504601f81018390048302860183019091528085529596929592945090919083018282801561091a5780601f106108ef5761010080835404028352916020019161091a565b820191906000526020600020905b8154815290600101906020018083116108fd57829003601f168201915b50505060059093015491925050600160a060020a0381169060ff740100000000000000000000000000000000000000009091041686565b6003805460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156104fc5780601f106104d1576101008083540402835291602001916104fc565b60e06040519081016040528060608152602001606081526020016000815260200160608152602001606081526020016000600160a060020a031681526020016000151581525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610a3657805160ff1916838001178555610a63565b82800160010185558215610a63579182015b82811115610a63578251825591602001919060010190610a48565b50610a6f929150610ae1565b5090565b828054828255906000526020600020908101928215610ad5579160200282015b82811115610ad5578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03909116178255602090920191600190910190610a93565b50610a6f929150610afb565b61050891905b80821115610a6f5760008155600101610ae7565b61050891905b80821115610a6f57805473ffffffffffffffffffffffffffffffffffffffff19168155600101610b015600a165627a7a72305820abf47ae6365972689d1d66d66358fdaf922b000c7409fcf16343758eaf7b17040029',

    factoryBytecode: '608060405234801561001057600080fd5b50d3801561001d57600080fd5b50d2801561002a57600080fd5b506113258061003a6000396000f3006080604052600436106100615763ffffffff7c0100000000000000000000000000000000000000000000000000000000600035041663435c2e38811461006657806343a05164146100b4578063a578861d146100f1578063d768468b14610170575b600080fd5b34801561007257600080fd5b50d3801561007f57600080fd5b50d2801561008c57600080fd5b5061009860043561025f565b60408051600160a060020a039092168252519081900360200190f35b3480156100c057600080fd5b50d380156100cd57600080fd5b50d280156100da57600080fd5b506100ef600160a060020a0360043516610287565b005b3480156100fd57600080fd5b50d3801561010a57600080fd5b50d2801561011757600080fd5b506101206102e3565b60408051602080825283518183015283519192839290830191858101910280838360005b8381101561015c578181015183820152602001610144565b505050509050019250505060405180910390f35b34801561017c57600080fd5b50d3801561018957600080fd5b50d2801561019657600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526100ef94369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a9998810197919650918201945092508291508401838280828437509497506103459650505050505050565b600080548290811061026d57fe5b600091825260209091200154600160a060020a0316905081565b600080546001810182559080527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56301805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a0392909216919091179055565b6060600080548060200260200160405190810160405280929190818152602001828054801561033b57602002820191906000526020600020905b8154600160a060020a0316815260019091019060200180831161031d575b5050505050905090565b600083838333610353610517565b600160a060020a0382166060820152608080825285519082015284518190602080830191604084019160a0850191908a019080838360005b838110156103a357818101518382015260200161038b565b50505050905090810190601f1680156103d05780820380516001836020036101000a031916815260200191505b50848103835287518152875160209182019189019080838360005b838110156104035781810151838201526020016103eb565b50505050905090810190601f1680156104305780820380516001836020036101000a031916815260200191505b50848103825286518152865160209182019188019080838360005b8381101561046357818101518382015260200161044b565b50505050905090810190601f1680156104905780820380516001836020036101000a031916815260200191505b50975050505050505050604051809103906000f0801580156104b6573d6000803e3d6000fd5b50600080546001810182559080527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56301805473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a039290921691909117905550505050565b604051610dd280610528833901905600608060405234801561001057600080fd5b50d3801561001d57600080fd5b50d2801561002a57600080fd5b5060405162000dd238038062000dd283398101604090815281516020808401519284015160608501519285018051909594850194919091019291610073916001918701906100cb565b5081516100879060029060208501906100cb565b50825161009b9060039060208601906100cb565b5060048054600160a060020a039092166101000261010060a860020a031990921691909117905550610166915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061010c57805160ff1916838001178555610139565b82800160010185558215610139579182015b8281111561013957825182559160200191906001019061011e565b50610145929150610149565b5090565b61016391905b80821115610145576000815560010161014f565b90565b610c5c80620001766000396000f3006080604052600436106100a35763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166302d05d3f81146100a857806306fdde03146100f35780631435ba3c14610197578063147b68db146101d85780633009060d146102cf5780633ced6738146102fe578063d06f73ac14610330578063d7efb6b71461035f578063e83ddcea146103a2578063ef430aa614610538575b600080fd5b3480156100b457600080fd5b50d380156100c157600080fd5b50d280156100ce57600080fd5b506100d7610567565b60408051600160a060020a039092168252519081900360200190f35b3480156100ff57600080fd5b50d3801561010c57600080fd5b50d2801561011957600080fd5b5061012261057b565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561015c578181015183820152602001610144565b50505050905090810190601f1680156101895780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156101a357600080fd5b50d380156101b057600080fd5b50d280156101bd57600080fd5b506101c6610608565b60408051918252519081900360200190f35b3480156101e457600080fd5b50d380156101f157600080fd5b50d280156101fe57600080fd5b506040805160206004803580820135601f81018490048402850184019095528484526102cd94369492936024939284019190819084018382808284375050604080516020601f89358b018035918201839004830284018301909452808352979a99988101979196509182019450925082915084018382808284375050604080516020601f818a01358b0180359182018390048302840183018552818452989b8a359b909a90999401975091955091820193509150819084018382808284375094975061060f9650505050505050565b005b3480156102db57600080fd5b50d380156102e857600080fd5b50d280156102f557600080fd5b506102cd610760565b34801561030a57600080fd5b50d3801561031757600080fd5b50d2801561032457600080fd5b506102cd60043561078b565b34801561033c57600080fd5b50d3801561034957600080fd5b50d2801561035657600080fd5b506101226107e0565b34801561036b57600080fd5b50d3801561037857600080fd5b50d2801561038557600080fd5b5061038e610838565b604080519115158252519081900360200190f35b3480156103ae57600080fd5b50d380156103bb57600080fd5b50d280156103c857600080fd5b506103d4600435610841565b60408051908101859052600160a060020a038316608082015281151560a082015260c080825287519082015286518190602080830191606084019160e0850191908c019080838360005b8381101561043657818101518382015260200161041e565b50505050905090810190601f1680156104635780820380516001836020036101000a031916815260200191505b5084810383528951815289516020918201918b019080838360005b8381101561049657818101518382015260200161047e565b50505050905090810190601f1680156104c35780820380516001836020036101000a031916815260200191505b50848103825287518152875160209182019189019080838360005b838110156104f65781810151838201526020016104de565b50505050905090810190601f1680156105235780820380516001836020036101000a031916815260200191505b50995050505050505050505060405180910390f35b34801561054457600080fd5b50d3801561055157600080fd5b50d2801561055e57600080fd5b50610122610a55565b6004546101009004600160a060020a031681565b60018054604080516020600284861615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156106005780601f106105d557610100808354040283529160200191610600565b820191906000526020600020905b8154815290600101906020018083116105e357829003601f168201915b505050505081565b6000545b90565b610617610ab0565b848152602080820185905260408201849052606082018390523360a0830152600060c08301819052805460018101808355918052835180519293859360069093027f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56301926106889284920190610af9565b5060208281015180516106a19260018501920190610af9565b5060408201516002820155606082015180516106c7916003840191602090910190610af9565b50608082015180516106e3916004840191602090910190610b77565b5060a08201516005909101805460c0909301511515740100000000000000000000000000000000000000000274ff000000000000000000000000000000000000000019600160a060020a0390931673ffffffffffffffffffffffffffffffffffffffff199094169390931791909116919091179055505050505050565b6004546101009004600160a060020a0316331461077c57600080fd5b6004805460ff19166001179055565b6000808281548110151561079b57fe5b600091825260208083206004600690930201919091018054600181018255908352912001805473ffffffffffffffffffffffffffffffffffffffff1916331790555050565b6002805460408051602060018416156101000260001901909316849004601f810184900484028201840190925281815292918301828280156106005780601f106105d557610100808354040283529160200191610600565b60045460ff1681565b600080548290811061084f57fe5b60009182526020918290206006919091020180546040805160026001841615610100026000190190931692909204601f8101859004850283018501909152808252919350918391908301828280156108e85780601f106108bd576101008083540402835291602001916108e8565b820191906000526020600020905b8154815290600101906020018083116108cb57829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109865780601f1061095b57610100808354040283529160200191610986565b820191906000526020600020905b81548152906001019060200180831161096957829003601f168201915b505050506002838101546003850180546040805160206001841615610100026000190190931695909504601f810183900483028601830190915280855295969295929450909190830182828015610a1e5780601f106109f357610100808354040283529160200191610a1e565b820191906000526020600020905b815481529060010190602001808311610a0157829003601f168201915b50505060059093015491925050600160a060020a0381169060ff740100000000000000000000000000000000000000009091041686565b6003805460408051602060026001851615610100026000190190941693909304601f810184900484028201840190925281815292918301828280156106005780601f106105d557610100808354040283529160200191610600565b60e06040519081016040528060608152602001606081526020016000815260200160608152602001606081526020016000600160a060020a031681526020016000151581525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610b3a57805160ff1916838001178555610b67565b82800160010185558215610b67579182015b82811115610b67578251825591602001919060010190610b4c565b50610b73929150610be5565b5090565b828054828255906000526020600020908101928215610bd9579160200282015b82811115610bd9578251825473ffffffffffffffffffffffffffffffffffffffff1916600160a060020a03909116178255602090920191600190910190610b97565b50610b73929150610bff565b61060c91905b80821115610b735760008155600101610beb565b61060c91905b80821115610b7357805473ffffffffffffffffffffffffffffffffffffffff19168155600101610c055600a165627a7a723058201656f869ea520e4e23472ce368e3ad93f9bba9c3af717e65a562c735725fef800029a165627a7a72305820062935766e9584ba4321e5b19a4813d66fd125729bf697bdd0de6ed664ce56220029'
};

export default utils;
